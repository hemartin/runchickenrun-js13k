function Body(state){this.state=state,this.id=state.nextBodyId++,this.origin=new Vector(0,0),this.angle=0,this.dimension=new Vector(.1,.1),this.mass=1,this.velocity=new Vector(0,0),this.angularVelocity=0,this.target=new Vector(0,0),this.targetRadius=0,this.thrust=2,this.eyesDir=new Vector(1,-3),this.cx=[0,0,0,0],this.cy=[0,0,0,0]}function FixedBody(state){Body.call(this,state),this.setMass(Body_INFINITE_MASS)}function Body_collide(state,body1,body2,timestep){var collision=new Collision(state);return Body_collideAllCorners(collision,body1,body2,timestep),collision.collisionPoints.length<2&&Body_collideAllCorners(collision,body2,body1,timestep),0===collision.collisionPoints.length?null:collision}function Body_collideAllCorners(collision,collidingBody,impactedBody,timestep){for(var corner=0;corner<4;corner++)impactedBody.collideSingleCorner(collision,collidingBody,corner,timestep)}function Button(game,text){this.game=game,this.text=text,this.origin=new Vector(0,0),this.dimension=new Vector(.45,.11),this.isDown=!1}function Collision(state){this.state=state,this.collisionPoints=[]}function Collision_mergeCollisions(collisions){if(collisions.length<=1)return collisions;var unionFind=new UnionFind;collisions.forEach(function(collision){var cp=collision.collisionPoints[0];unionFind.union(cp.collidingEntity.id,cp.impactedEntity.id)});var mergedCollisionMap=[];collisions.forEach(function(collision){var cp=collision.collisionPoints[0],compId=unionFind.find(cp.collidingEntity.id);void 0===mergedCollisionMap[compId]?mergedCollisionMap[compId]=collision:mergedCollisionMap[compId].merge(collision)});var mergedCollisions=[];return mergedCollisionMap.forEach(function(collision){mergedCollisions.push(collision)}),mergedCollisions}function CollisionPoint(collidingEntity,impactedEntity,normal_x,normal_y,contactPoint_x,contactPoint_y,separation){this.collidingEntity=collidingEntity,this.impactedEntity=impactedEntity,this.normal_x=normal_x,this.normal_y=normal_y,this.contactPoint_x=contactPoint_x,this.contactPoint_y=contactPoint_y,this.separation=separation,this.accumulatedImpulse=0,this.nv1=new Vector(0,0),this.nw1=0,this.nv2=new Vector(0,0),this.nw2=0}function createGame(){var canvas=document.getElementById("c"),context=canvas.getContext("2d");resizeCanvas(canvas);var state=new State;return state.init(),{canvas:canvas,context:context,state:state,camera:new Vector(-CANVAS_WIDTH,0),isRunning:!1,lastScore:0,lastTotalScore:0,totalScore:0,multiplier:1,clickCount:0,lastClickCount:0,lastClickTime:0}}function runGame(game){function step(now){0===start&&(start=now),0===previous&&(previous=now);for(var timestep=now-previous+remainder;timestep>fixedTimestep;)game.state.advance(fixedTimestep/1e3),timestep-=fixedTimestep;previous=now,remainder=timestep,drawGame(game,!0,!1),0==game.lastClickTime&&(game.lastClickTime=now),game.clickCount==game.lastClickCount?now-game.lastClickTime>1e4&&endGame(game):(game.lastClickCount=game.clickCount,game.lastClickTime=now),game.state.foxAteChicken&&endGame(game),game.isRunning&&window.requestAnimationFrame(step)}game.isRunning=!0;var fixedTimestep=10,start=0,previous=0,remainder=0;window.requestAnimationFrame(step)}function endGame(game){game.isRunning=!1,game.state.eatenGrains>game.lastScore?(game.lastTotalScore=game.totalScore,game.totalScore+=game.multiplier*game.state.eatenGrains,currentScreen=new EndOfRoundScreen(game)):(game.lastTotalScore=game.totalScore,game.totalScore+=game.state.eatenGrains,currentScreen=new GameOverScreen(game)),currentScreen.draw()}function drawGame(game,includeChickenFox,lightColors){game.context.fillStyle=BACKGROUND,game.context.fillRect(0,0,game.canvas.width,game.canvas.height),game.camera.x=Math.max(game.camera.x,game.state.chicken.origin.x+.1*CANVAS_WIDTH),game.state.updateInvisibleWall(game.camera),game.state.updateTrees(game.camera);for(var colors=lightColors?LIGHT_COLORS:COLORS,t=0,g=0,c=!includeChickenFox,f=!includeChickenFox;t<game.state.trees.length&&g<game.state.grains.length;)!c&&game.state.chicken.origin.y>game.state.trees[t].origin.y&&game.state.chicken.origin.y>game.state.grains[g].origin.y&&(drawChicken(game,game.state.chicken,colors),c=!0),!f&&game.state.fox.origin.y>game.state.trees[t].origin.y&&game.state.fox.origin.y>game.state.grains[g].origin.y&&(drawFox(game,game.state.fox,colors),f=!0),game.state.trees[t].origin.y>game.state.grains[g].origin.y?drawTree(game,game.state.trees[t++],colors):drawGrain(game,game.state.grains[g++],colors);for(;t<game.state.trees.length;)!c&&game.state.chicken.origin.y>game.state.trees[t].origin.y&&(drawChicken(game,game.state.chicken,colors),c=!0),!f&&game.state.fox.origin.y>game.state.trees[t].origin.y&&(drawFox(game,game.state.fox,colors),f=!0),drawTree(game,game.state.trees[t++],colors);for(;g<game.state.grains.length;)!c&&game.state.chicken.origin.y>game.state.grains[g].origin.y&&(drawChicken(game,game.state.chicken,colors),c=!0),!f&&game.state.fox.origin.y>game.state.grains[g].origin.y&&(drawFox(game,game.state.fox,colors),f=!0),drawGrain(game,game.state.grains[g++],colors);if(c||drawChicken(game,game.state.chicken,colors),f||drawFox(game,game.state.fox,colors),drawTarget(game,game.state.chicken),includeChickenFox){game.context.fillStyle=FONT_COLOR,game.context.font=game.canvas.height*TEXT_HEIGHT+FONT,game.context.textAlign="right";var text=""+game.state.eatenGrains;game.multiplier>1&&(text+=" ("+game.lastScore+")"),game.context.fillText(text,tx(game,SCORE_X+game.camera.x),ty(game,SCORE_Y))}}function drawChicken(game,body,colors){var context=game.context;context.fillStyle=colors[6],context.beginPath(),context.moveTo(tx(game,body.cx[0]),ty(game,body.cy[0])),context.lineTo(tx(game,body.cx[1]),ty(game,body.cy[1])),context.lineTo(tx(game,body.cx[2]),ty(game,body.cy[2])),context.lineTo(tx(game,body.cx[3]),ty(game,body.cy[3])),context.closePath(),context.fill();var p1x=body.cx[0]+.5*(body.cx[3]-body.cx[0]),p1y=body.cy[0]+.5*(body.cy[3]-body.cy[0]),p2x=body.cx[1]+.5*(body.cx[2]-body.cx[1]),p2y=body.cy[1]+.5*(body.cy[2]-body.cy[1]),p3x=body.cx[2]+.5*(body.cx[3]-body.cx[2]),p3y=body.cy[2]+.5*(body.cy[3]-body.cy[2]);context.fillStyle=colors[5],context.beginPath(),context.moveTo(tx(game,p1x),ty(game,p1y)),context.lineTo(tx(game,p2x),ty(game,p2y)),context.lineTo(tx(game,p3x),ty(game,p3y)),context.closePath(),context.fill(),context.fillStyle=colors[8],context.beginPath(),context.moveTo(tx(game,p1x),ty(game,p1y)),context.lineTo(tx(game,body.origin.x),ty(game,body.origin.y)),context.lineTo(tx(game,p3x),ty(game,p3y)),context.closePath(),context.fill();var p4x=body.cx[0]+.5*(body.cx[1]-body.cx[0]),p4y=body.cy[0]+.5*(body.cy[1]-body.cy[0]),p5x=body.origin.x+1.4*(p4x-body.origin.x),p5y=body.origin.y+1.4*(p4y-body.origin.y);context.fillStyle=colors[1],context.beginPath(),context.moveTo(tx(game,body.cx[0]),ty(game,body.cy[0])),context.lineTo(tx(game,body.cx[1]),ty(game,body.cy[1])),context.lineTo(tx(game,p5x),ty(game,p5y)),context.closePath(),context.fill();var elx=body.origin.x+.5*(body.cx[1]-body.origin.x),ely=body.origin.y+.5*(body.cy[1]-body.origin.y),erx=body.origin.x+.5*(body.cx[0]-body.origin.x),ery=body.origin.y+.5*(body.cy[0]-body.origin.y),erx2=erx+.14*(elx-erx),ery2=ery+.14*(ely-ery);drawEye(game,body,elx+.14*(erx-elx),ely+.14*(ery-ely),.2*body.dimension.x),drawEye(game,body,erx2,ery2,.2*body.dimension.x)}function drawFox(game,body,colors){var context=game.context;context.fillStyle=colors[2],context.beginPath(),context.moveTo(tx(game,body.cx[0]),ty(game,body.cy[0])),context.lineTo(tx(game,body.cx[1]),ty(game,body.cy[1])),context.lineTo(tx(game,body.cx[2]),ty(game,body.cy[2])),context.lineTo(tx(game,body.cx[3]),ty(game,body.cy[3])),context.closePath(),context.fill();var p1x=body.origin.x+2*(body.cx[0]-body.origin.x),p1y=body.origin.y+2*(body.cy[0]-body.origin.y),p2x=body.origin.x+2*(body.cx[1]-body.origin.x),p2y=body.origin.y+2*(body.cy[1]-body.origin.y),p3x=body.cx[0]+.5*(body.cx[1]-body.cx[0]),p3y=body.cy[0]+.5*(body.cy[1]-body.cy[0]),p4x=body.cx[2]+.5*(body.cx[3]-body.cx[2]),p4y=body.cy[2]+.5*(body.cy[3]-body.cy[2]);context.fillStyle=colors[1],context.beginPath(),context.moveTo(tx(game,p4x),ty(game,p4y)),context.lineTo(tx(game,p1x),ty(game,p1y)),context.lineTo(tx(game,p3x),ty(game,p3y)),context.lineTo(tx(game,p2x),ty(game,p2y)),context.closePath(),context.fill();var elx=body.origin.x+.5*(body.cx[1]-body.origin.x),ely=body.origin.y+.5*(body.cy[1]-body.origin.y),erx=body.origin.x+.5*(body.cx[0]-body.origin.x),ery=body.origin.y+.5*(body.cy[0]-body.origin.y),erx2=erx+.14*(elx-erx),ery2=ery+.14*(ely-ery);drawEye(game,body,elx+.14*(erx-elx),ely+.14*(ery-ely),.22*body.dimension.x),drawEye(game,body,erx2,ery2,.22*body.dimension.x)}function drawEye(game,body,x,y,radius){var context=game.context,whiteRadius=tx(game,radius)-tx(game,0);context.fillStyle=CHICKEN_WHITE,context.beginPath(),context.arc(tx(game,x),ty(game,y),whiteRadius,0,2*Math.PI,!1),context.fill();body.cx[2],body.cx[3],body.cx[2],body.cy[2],body.cy[3],body.cy[2];context.fillStyle=FONT_COLOR;var darkRadius=.6*whiteRadius,dir=new Vector(body.eyesDir.x,body.eyesDir.y);dir.normalize().scale(.2*radius),x+=dir.x,y+=dir.y,context.beginPath(),context.arc(tx(game,x),ty(game,y),darkRadius,0,2*Math.PI,!1),context.fill(),context.fillStyle=CHICKEN_WHITE;var glowRadius=.2*whiteRadius;x+=.2*radius,y+=.2*radius,context.beginPath(),context.arc(tx(game,x),ty(game,y),glowRadius,0,2*Math.PI,!1),context.fill()}function drawTree(game,body,colors){var context=game.context,ulx=body.cx[1],uly=body.cy[1];context.fillStyle=colors[8],context.beginPath(),context.moveTo(tx(game,ulx),ty(game,uly)),context.lineTo(tx(game,ulx+body.dimension.x),ty(game,uly)),context.lineTo(tx(game,ulx+body.dimension.x),ty(game,uly-body.dimension.y)),context.lineTo(tx(game,ulx),ty(game,uly-body.dimension.y)),context.closePath(),context.fill(),context.fillStyle=colors[5],context.beginPath(),context.moveTo(tx(game,ulx),ty(game,uly)),context.lineTo(tx(game,ulx+.7*body.dimension.x),ty(game,uly)),context.lineTo(tx(game,ulx+.7*body.dimension.x),ty(game,uly-body.dimension.y)),context.lineTo(tx(game,ulx),ty(game,uly-body.dimension.y)),context.closePath(),context.fill(),ulx=body.origin.x-1.2*body.dimension.x,context.fillStyle=colors[13],context.beginPath(),context.moveTo(tx(game,ulx),ty(game,uly)),context.lineTo(tx(game,ulx+2.4*body.dimension.x),ty(game,uly)),context.lineTo(tx(game,body.origin.x),ty(game,uly+2.7*body.dimension.y)),context.closePath(),context.fill(),context.fillStyle=colors[10],context.beginPath(),context.moveTo(tx(game,ulx),ty(game,uly)),context.lineTo(tx(game,body.origin.x),ty(game,uly)),context.lineTo(tx(game,body.origin.x),ty(game,uly+2.7*body.dimension.y)),context.closePath(),context.fill()}function drawGrain(game,body,colors){var context=game.context,ulx=body.cx[1],uly=body.cy[1];context.fillStyle=colors[18],context.beginPath(),context.moveTo(tx(game,ulx),ty(game,uly)),context.lineTo(tx(game,ulx+body.dimension.x),ty(game,uly)),context.lineTo(tx(game,ulx+body.dimension.x),ty(game,uly-body.dimension.y)),context.lineTo(tx(game,ulx),ty(game,uly-body.dimension.y)),context.closePath(),context.fill(),context.fillStyle=colors[15],context.beginPath(),context.moveTo(tx(game,ulx),ty(game,uly)),context.lineTo(tx(game,ulx+body.dimension.x),ty(game,uly)),context.lineTo(tx(game,ulx),ty(game,uly-body.dimension.y)),context.closePath(),context.fill()}function drawButton(game,button){var ulx=button.origin.x-button.dimension.x/2+game.camera.x,uly=button.origin.y+button.dimension.y/2,diff=button.isDown?.02:0;game.context.fillStyle=COLORS[8],game.context.beginPath(),game.context.moveTo(tx(game,ulx),ty(game,uly)),game.context.lineTo(tx(game,ulx+button.dimension.x),ty(game,uly)),game.context.lineTo(tx(game,ulx+button.dimension.x),ty(game,uly-button.dimension.y)),game.context.lineTo(tx(game,ulx),ty(game,uly-button.dimension.y)),game.context.closePath(),game.context.fill(),ulx+=diff,uly-=diff,game.context.fillStyle=COLORS[9],game.context.beginPath(),game.context.moveTo(tx(game,ulx),ty(game,uly)),game.context.lineTo(tx(game,ulx+button.dimension.x-.02),ty(game,uly)),game.context.lineTo(tx(game,ulx+button.dimension.x-.02),ty(game,uly-button.dimension.y)),game.context.lineTo(tx(game,ulx),ty(game,uly-button.dimension.y)),game.context.closePath(),game.context.fill(),game.context.fillStyle=CHICKEN_WHITE,game.context.font=game.canvas.height*TEXT_HEIGHT+FONT,game.context.textAlign="center",game.context.fillText(button.text,tx(game,button.origin.x+game.camera.x+diff),ty(game,button.origin.y-diff-.48*button.dimension.y/2))}function drawTarget(game,body){if(body.targetRadius>0){game.context.fillStyle=CHICKEN_WHITE,game.context.beginPath();var rx=game.canvas.width/2*body.targetRadius;game.context.arc(tx(game,body.target.x),ty(game,body.target.y),rx,0,2*Math.PI,!1),game.context.fill()}}function tx(game,x){return game.canvas.width/2*(x-game.camera.x+1)}function x(game,tx){return tx/game.canvas.width*2-1+game.camera.x}function ty(game,y){return-game.canvas.width/2*(y-game.camera.y)+game.canvas.height/2}function y(game,ty){return-ty/game.canvas.width*2+game.canvas.height/game.canvas.width+game.camera.y}function toClickVector(game,e){var clientRect=game.canvas.getBoundingClientRect();return new Vector(x(game,e.clientX-clientRect.left),y(game,e.clientY-clientRect.top))}function resizeCanvas(canvas){var w=window.innerWidth,h=CANVAS_HEIGHT*w/CANVAS_WIDTH;canvas.width!==w&&(canvas.width=w,canvas.height=h)}function resizeCanvasInGame(game){resizeCanvas(game.canvas),game.isRunning||currentScreen.draw()}function SplashScreen(game){this.game=game,this.startButton=new Button(this.game,"Start"),this.startButton.origin.y=-.07}function GetReadyScreen(game){this.game=game}function GamePlayScreen(game){this.game=game}function EndOfRoundScreen(game){this.dy=.15,this.game=game,this.headline="End of Round",this.playButton=new Button(this.game,"Play"),this.playButton.origin.y=this.dy-.35}function GameOverScreen(game){this.dy=.15,this.game=game,this.startButton=new Button(this.game,"Start"),this.startButton.origin.y=this.dy-.4}function drawSummary(game,dy,multiplierStr,newTotalLabel){var textHeight=.8*TEXT_HEIGHT,lineY=dy;drawTextAlign(game,"Last Total",.12,lineY,.8,FONT_ALIGN_RIGHT),drawTextAlign(game,game.lastTotalScore.toLocaleString(),.17,lineY,.8,FONT_ALIGN_LEFT),drawTextAlign(game,"+",-.23,lineY-=1.2*textHeight,.8,FONT_ALIGN_CENTER),drawTextAlign(game,"Last Round",.12,lineY,.8,FONT_ALIGN_RIGHT),drawTextAlign(game,game.state.eatenGrains.toLocaleString(),.17,lineY,.8,FONT_ALIGN_LEFT),drawTextAlign(game,"x",-.23,lineY-=1.2*textHeight,.8,FONT_ALIGN_CENTER),drawTextAlign(game,"Multiplier",.12,lineY,.8,FONT_ALIGN_RIGHT),drawTextAlign(game,multiplierStr,.17,lineY,.8,FONT_ALIGN_LEFT);var context=game.context;context.strokeStyle=FONT_COLOR,context.beginPath(),context.moveTo(tx(game,-.4+game.camera.x),ty(game,lineY-.025)),context.lineTo(tx(game,.4+game.camera.x),ty(game,lineY-.025)),context.stroke(),drawTextAlign(game,"=",-.23,lineY-=1.6*textHeight,.8,FONT_ALIGN_CENTER),drawTextAlign(game,newTotalLabel,.12,lineY,.8,FONT_ALIGN_RIGHT),drawTextAlign(game,game.totalScore.toLocaleString(),.17,lineY,.8,FONT_ALIGN_LEFT)}function drawText(game,text,x,y,size){drawTextAlign(game,text,x,y,size,FONT_ALIGN_CENTER)}function drawTextAlign(game,text,x,y,size,align){var textHeight=size*game.canvas.height*TEXT_HEIGHT;game.context.fillStyle=FONT_COLOR,game.context.font=textHeight+FONT,game.context.textAlign=align,game.context.fillText(text,tx(game,x+game.camera.x),ty(game,y))}function State(){this.chicken=null,this.fox=null,this.walls=[],this.trees=[],this.grains=[],this.invisibleWall=null,this.treeCenter=-CANVAS_WIDTH,this.eatenGrains=0,this.foxAteChicken=!1,this.nextBodyId=0}function UnionFindNode(id){this.id=id,this.rank=0,this.parent=this}function UnionFind(){this.nodes=[]}function Vector(x,y){this.x=x,this.y=y}function Vector_cross(v1_x,v1_y,v2_x,v2_y){return v1_x*v2_y-v1_y*v2_x}function Vector_dot(v1_x,v1_y,v2_x,v2_y){return v1_x*v2_x+v1_y*v2_y}function Vector_length(x,y){return Math.sqrt(x*x+y*y)}var Body_INFINITE_MASS=-1;(FixedBody.prototype=Object.create(Body.prototype)).constructor=FixedBody,Body.prototype.finalize=function(){return this.inertia=(this.dimension.x*this.dimension.x+this.dimension.y*this.dimension.y)*this.mass/12,this.calculateCorners(),this},Body.prototype.setOrigin=function(x,y){return this.origin.x=x,this.origin.y=y,this},Body.prototype.setAngle=function(a){return this.angle=a,this},Body.prototype.setDimension=function(x,y){return this.dimension.x=x,this.dimension.y=y,this},Body.prototype.setMass=function(m){return this.mass=m,this},Body.prototype.applyForces=function(timestep){if(this.targetRadius>0){var force_x=this.target.x-this.origin.x,force_y=this.target.y-this.origin.y,force_len=Vector_length(force_x,force_y);force_x*=this.thrust/force_len,force_y*=this.thrust/force_len,this.velocity.x+=force_x*timestep*this.invertedMass(),this.velocity.y+=force_y*timestep*this.invertedMass()}this.velocity.scale(Math.max(0,1-timestep*LATERAL_FRICTION)),this.angularVelocity*=Math.max(0,1-timestep*ROTATIONAL_FRICTION)},Body.prototype.advance=function(timestep){this.origin.x+=this.velocity.x*timestep,this.origin.y+=this.velocity.y*timestep,this.angle+=this.angularVelocity*timestep,this.angle>Math.Pi?this.angle-=2*Math.Pi:this.angle<-Math.Pi&&(this.angle+=2*Math.Pi),this.calculateCorners()},Body.prototype.calculateCorners=function(){var direction_y=Math.sin(this.angle),direction_x=Math.cos(this.angle),tangent_x=-direction_y,tangent_y=direction_x;this.cx[0]=this.origin.x+direction_x*this.dimension.x*.5+tangent_x*this.dimension.y*.5,this.cy[0]=this.origin.y+direction_y*this.dimension.x*.5+tangent_y*this.dimension.y*.5,this.cx[1]=this.origin.x-direction_x*this.dimension.x*.5+tangent_x*this.dimension.y*.5,this.cy[1]=this.origin.y-direction_y*this.dimension.x*.5+tangent_y*this.dimension.y*.5,this.cx[2]=this.origin.x-direction_x*this.dimension.x*.5-tangent_x*this.dimension.y*.5,this.cy[2]=this.origin.y-direction_y*this.dimension.x*.5-tangent_y*this.dimension.y*.5,this.cx[3]=this.origin.x+direction_x*this.dimension.x*.5-tangent_x*this.dimension.y*.5,this.cy[3]=this.origin.y+direction_y*this.dimension.x*.5-tangent_y*this.dimension.y*.5},Body.prototype.checkTarget=function(){this.targetRadius>0&&this.target.distanceFrom(this.origin)<this.targetRadius&&(this.targetRadius=0)},Body.prototype.invertedMass=function(){return this.isFixedBody()?0:1/this.mass},Body.prototype.invertedInertia=function(){return this.isFixedBody()||0===this.inertia?0:1/this.inertia},Body.prototype.isFixedBody=function(){return this.mass===Body_INFINITE_MASS},Body.prototype.addVelocity=function(velocity){this.velocity.add(velocity)},Body.prototype.addAngularVelocity=function(angularVelocity){this.angularVelocity+=angularVelocity},Body.prototype.collideSingleCorner=function(collision,collidingBody,corner,timestep){var vertex_x=collidingBody.cx[corner],vertex_y=collidingBody.cy[corner],x=vertex_x-this.origin.x,y=vertex_y-this.origin.y,cos=Math.cos(-this.angle),sin=Math.sin(-this.angle),ty=x*sin+y*cos;x=x*cos-y*sin,y=ty;var halflength=.5*this.dimension.x,halfwidth=.5*this.dimension.y;if(x>=-halflength-1e-5&&x<=halflength+1e-5&&y>=-halfwidth-1e-5&&y<=halfwidth+1e-5){var v1=collidingBody.velocity,w1=collidingBody.angularVelocity,v2=this.velocity,w2=this.angularVelocity,r1_x=vertex_x-collidingBody.origin.x,r1_y=vertex_y-collidingBody.origin.y,r2_x=vertex_x-this.origin.x,relativeVelocity_x=-w1*r1_y,relativeVelocity_y=w1*r1_x;relativeVelocity_x-=-w2*(vertex_y-this.origin.y),relativeVelocity_y-=w2*r2_x,relativeVelocity_x-=v2.x,relativeVelocity_y-=v2.y;var relativeMove_x=(relativeVelocity_x+=v1.x)*timestep,relativeMove_y=(relativeVelocity_y+=v1.y)*timestep,cos1=Math.cos(-this.angle),sin1=Math.sin(-this.angle),ty1=relativeMove_x*sin1+relativeMove_y*cos1;relativeMove_x=relativeMove_x*cos1-relativeMove_y*sin1;var separation=halfwidth-y,minSeparation=separation,maxEdge=0,minEdge=0;separation<-(relativeMove_y=ty1)&&(maxEdge=1),(separation=halflength+x)<relativeMove_x&&(maxEdge|=2),separation<minSeparation&&(minSeparation=separation,minEdge=1),(separation=halfwidth+y)<relativeMove_y&&(maxEdge|=4),separation<minSeparation&&(minSeparation=separation,minEdge=2),(separation=halflength-x)<-relativeMove_x&&(maxEdge|=8),separation<minSeparation&&(minSeparation=separation,minEdge=3);var normal_x,normal_y;if(maxEdge>0){var count=0;normal_x=0,normal_y=0;for(var i=0;i<4;i++)if((maxEdge&1<<i)>0){var impactedCorner2=3===(impactedCorner1=i)?0:impactedCorner1+1,en_x=this.cx[impactedCorner1]-this.cx[impactedCorner2],tmp=en_x*=div=1/Vector_length(en_x,en_y=this.cy[impactedCorner1]-this.cy[impactedCorner2]);normal_x+=en_x=-(en_y*=div),normal_y+=en_y=tmp,count++}if(count>1){var normal_len=Vector_length(normal_x,normal_y);normal_x/=normal_len,normal_y/=normal_len}}else{var impactedCorner1=minEdge,impactedCorner2=3===impactedCorner1?0:impactedCorner1+1,en_x=this.cx[impactedCorner1]-this.cx[impactedCorner2],en_y=this.cy[impactedCorner1]-this.cy[impactedCorner2],div=1/Vector_length(en_x,en_y),tmp=en_x*=div;normal_x=en_x=-(en_y*=div),normal_y=en_y=tmp}var collisionPoint=new CollisionPoint(collidingBody,this,normal_x,normal_y,vertex_x,vertex_y,minSeparation);collision.collisionPoints.push(collisionPoint)}},Button.prototype.clicked=function(click){var cx=click.x-this.game.camera.x;return cx>=this.origin.x-this.dimension.x/2&&cx<=this.origin.x+this.dimension.x/2&&click.y>=this.origin.y-this.dimension.y/2&&click.y<=this.origin.y+this.dimension.y/2},Button.prototype.down=function(click){var cx=click.x-this.game.camera.x;this.isDown=cx>=this.origin.x-this.dimension.x/2&&cx<=this.origin.x+this.dimension.x/2&&click.y>=this.origin.y-this.dimension.y/2&&click.y<=this.origin.y+this.dimension.y/2},Button.prototype.up=function(click){this.isDown=!1},Collision.prototype.merge=function(collision){this.collisionPoints.addAll(collision.collisionPoints)},Collision.prototype.apply=function(){var collisionCount=this.collisionPoints.length,originalDeltas_x=[],originalDeltas_y=[],iteration=0,accumulatedImpulse=0,previousAccumulatedImpulse=Number.MAX_VALUE;do{accumulatedImpulse>0&&(previousAccumulatedImpulse=accumulatedImpulse),accumulatedImpulse=0;for(var j=0;j<collisionCount;j++){var collisionPoint=this.collisionPoints[j],v1=collisionPoint.collidingEntity.velocity,w1=collisionPoint.collidingEntity.angularVelocity,v2=collisionPoint.impactedEntity.velocity,w2=collisionPoint.impactedEntity.angularVelocity,ceo=collisionPoint.collidingEntity.origin,r1_x=collisionPoint.contactPoint_x-ceo.x,r1_y=collisionPoint.contactPoint_y-ceo.y,ieo=collisionPoint.impactedEntity.origin,r2_x=collisionPoint.contactPoint_x-ieo.x,r2_y=collisionPoint.contactPoint_y-ieo.y,normalMass=collisionPoint.getNormalMass(),delta_x=-w1*r1_y,delta_y=w1*r1_x;delta_x-=-w2*r2_y,delta_y-=w2*r2_x,delta_x-=v2.x,delta_y-=v2.y,delta_x+=v1.x,delta_y+=v1.y,0===iteration&&(originalDeltas_x[j]=delta_x*RESTITUTION,originalDeltas_y[j]=delta_y*RESTITUTION);var normalImpulse=-(Vector_dot(originalDeltas_x[j],originalDeltas_y[j],collisionPoint.normal_x,collisionPoint.normal_y)+Vector_dot(delta_x,delta_y,collisionPoint.normal_x,collisionPoint.normal_y))*normalMass,tmp=collisionPoint.accumulatedImpulse;collisionPoint.accumulatedImpulse=Math.max(collisionPoint.accumulatedImpulse+normalImpulse,0),normalImpulse=collisionPoint.accumulatedImpulse-tmp,accumulatedImpulse+=Math.abs(normalImpulse);var impulse_x=collisionPoint.normal_x*normalImpulse,impulse_y=collisionPoint.normal_y*normalImpulse,ce_im=collisionPoint.collidingEntity.invertedMass(),nv1_x=impulse_x*ce_im,nv1_y=impulse_y*ce_im,nw1=collisionPoint.collidingEntity.invertedInertia()*Vector_cross(r1_x,r1_y,impulse_x,impulse_y),ie_im=collisionPoint.impactedEntity.invertedMass(),nv2_x=impulse_x*ie_im,nv2_y=impulse_y*ie_im;nv2_x=-nv2_x,nv2_y=-nv2_y;var nw2=-collisionPoint.impactedEntity.invertedInertia()*Vector_cross(r2_x,r2_y,impulse_x,impulse_y);collisionPoint.addTempVelocities(nv1_x,nv1_y,nw1,nv2_x,nv2_y,nw2)}for(var i=0;i<collisionCount;i++)this.collisionPoints[i].applyTempVelocities();iteration++}while(collisionCount>1&&accumulatedImpulse>.001&&iteration<50&&accumulatedImpulse<=previousAccumulatedImpulse)},CollisionPoint.prototype.getNormalMass=function(){var ceo=this.collidingEntity.origin,r1_x=ceo.x-this.contactPoint_x,r1_y=ceo.y-this.contactPoint_y,ieo=this.impactedEntity.origin,r2_x=ieo.x-this.contactPoint_x,r2_y=ieo.y-this.contactPoint_y,cp1=Vector_cross(r1_x,r1_y,this.normal_x,this.normal_y);cp1*=cp1;var cp2=Vector_cross(r2_x,r2_y,this.normal_x,this.normal_y);return cp2*=cp2,1/(this.collidingEntity.invertedMass()+this.impactedEntity.invertedMass()+cp1*this.collidingEntity.invertedInertia()+cp2*this.impactedEntity.invertedInertia())},CollisionPoint.prototype.addTempVelocities=function(v1_x,v1_y,w1,v2_x,v2_y,w2){this.nv1.x+=v1_x,this.nv1.y+=v1_y,this.nw1+=w1,this.nv2.x+=v2_x,this.nv2.y+=v2_y,this.nw2+=w2},CollisionPoint.prototype.applyTempVelocities=function(){this.collidingEntity.addVelocity(this.nv1),this.collidingEntity.addAngularVelocity(this.nw1),this.impactedEntity.addVelocity(this.nv2),this.impactedEntity.addAngularVelocity(this.nw2),this.nv1.clear(),this.nw1=0,this.nv2.clear(),this.nw2=0};var CANVAS_WIDTH=2,CANVAS_HEIGHT=1,RESTITUTION=.5,LATERAL_FRICTION=1.5,ROTATIONAL_FRICTION=7.5,FONT="px Verdena, sans-serif",FONT_COLOR="#5f4808",TEXT_HEIGHT=.07,FONT_ALIGN_CENTER="center",FONT_ALIGN_LEFT="left",FONT_ALIGN_RIGHT="right",SCORE_X=(CANVAS_WIDTH-TEXT_HEIGHT)/2,SCORE_Y=CANVAS_HEIGHT/2-1.1*TEXT_HEIGHT,BACKGROUND="#c4e5d2",CHICKEN_WHITE="#fcf9de",COLORS=["#FD0006","#FD6367","#FD393E","#C30005","#990004","#FF7F00","#FFB163","#FF9B39","#C56200","#9B4D00","#00B64F","#4EC883","#2ABA69","#008C3D","#006E30","#FFC500","#FFDB63","#FFD239","#C59800","#9B7700"],LIGHT_COLORS=["#FDA7A9","#FEDCDD","#FEC3C4","#EA7F81","#CD5558","#FFD3A8","#FFEEDD","#FFE1C4","#ECB680","#CF9256","#7DBD99","#C5E4D2","#A1D2B6","#5BA97D","#3D9363","#FFEBA8","#FFF7DD","#FFF1C4","#ECD380","#CFB356"],currentScreen=null;window.onload=function(){var game=createGame();currentScreen=new SplashScreen(game),window.addEventListener("resize",function(e){resizeCanvasInGame(game)}),game.canvas.addEventListener("click",function(e){game.clickCount++,currentScreen=currentScreen.onClick(toClickVector(game,e)),game.isRunning||currentScreen.draw()}),game.canvas.addEventListener("mousedown",function(e){currentScreen.onMouseDown(toClickVector(game,e)),game.isRunning||currentScreen.draw()}),game.canvas.addEventListener("mouseup",function(e){currentScreen.onMouseUp(toClickVector(game,e)),game.isRunning||currentScreen.draw()}),currentScreen.draw()},SplashScreen.prototype.draw=function(){drawGame(this.game,!1,!0),drawText(this.game,"Run Chicken Run",0,.12,2),drawText(this.game,"A chicken, lost in the woods, runs from the fox.",0,.05,.7),drawButton(this.game,this.startButton)},SplashScreen.prototype.onClick=function(click){return this.startButton.clicked(click)?new GetReadyScreen(this.game):this},SplashScreen.prototype.onMouseDown=function(click){this.startButton.down(click)},SplashScreen.prototype.onMouseUp=function(click){this.startButton.up(click)},GetReadyScreen.prototype.draw=function(){drawGame(this.game,!0,!1),drawText(this.game,"Get Ready",0,.2,2);var context=this.game.context,ulx=this.game.camera.x;context.fillStyle=CHICKEN_WHITE,context.beginPath(),context.moveTo(tx(this.game,ulx),ty(this.game,.02)),context.lineTo(tx(this.game,ulx+.1+.01),ty(this.game,.02)),context.lineTo(tx(this.game,ulx+.1+.01),ty(this.game,-.02)),context.lineTo(tx(this.game,ulx),ty(this.game,-.02)),context.closePath(),context.fill(),context.beginPath(),context.moveTo(tx(this.game,ulx+.1),ty(this.game,.042)),context.lineTo(tx(this.game,ulx+1.6*.1),ty(this.game,0)),context.lineTo(tx(this.game,ulx+.1),ty(this.game,-.042)),context.closePath(),context.fill();for(var i=0;i<3;i++){context.fillStyle=CHICKEN_WHITE;var tarx=this.game.camera.x+.275+.15*i;context.beginPath();var rx=this.game.canvas.width/2*.05;context.arc(tx(this.game,tarx),ty(this.game,0),rx,0,2*Math.PI,!1),context.fill(),drawText(this.game,"click",.275+.15*i,-.12,.8)}},GetReadyScreen.prototype.onClick=function(click){return runGame(this.game),this.game.state.chicken.target.set(click),this.game.state.chicken.targetRadius=.08,new GamePlayScreen(this.game)},GetReadyScreen.prototype.onMouseDown=function(click){},GetReadyScreen.prototype.onMouseUp=function(click){},GamePlayScreen.prototype.draw=function(){drawGame(this.game,!0,!1)},GamePlayScreen.prototype.onClick=function(click){return this.game.state.chicken.target.set(click),this.game.state.chicken.targetRadius=.08,this},GamePlayScreen.prototype.onMouseDown=function(click){},GamePlayScreen.prototype.onMouseUp=function(click){},EndOfRoundScreen.prototype.draw=function(){drawGame(this.game,!0,!0),drawText(this.game,this.headline,0,.1+this.dy,2),drawSummary(this.game,this.dy,this.game.multiplier+"x","New Total"),drawButton(this.game,this.playButton);var newMulti=this.game.multiplier+1,pointS=1==this.game.state.eatenGrains?"":"s";drawText(this.game,newMulti+"x multiplier next round if more ",0,this.dy-.455,.6),drawText(this.game,"than "+this.game.state.eatenGrains+" point"+pointS+", or game over",0,this.dy-.5,.6)},EndOfRoundScreen.prototype.onClick=function(click){if(this.playButton.clicked(click)){this.game.lastScore=this.game.state.eatenGrains;var state=new State;return state.init(),this.game.state=state,this.game.camera.x=-CANVAS_WIDTH,this.game.multiplier++,this.game.clickCount=0,this.game.lastClickCount=0,this.game.lastClickTime=0,new GetReadyScreen(this.game)}return this},EndOfRoundScreen.prototype.onMouseDown=function(click){this.playButton.down(click)},EndOfRoundScreen.prototype.onMouseUp=function(click){this.playButton.up(click)},GameOverScreen.prototype.draw=function(){drawGame(this.game,!0,!0),drawText(this.game,"Game Over",0,.1+this.dy,2),drawSummary(this.game,this.dy,"--","Final Total"),drawButton(this.game,this.startButton)},GameOverScreen.prototype.onClick=function(click){if(this.startButton.clicked(click)){var state=new State;return state.init(),this.game.state=state,this.game.camera.x=-CANVAS_WIDTH,this.game.lastScore=0,this.game.totalScore=0,this.game.multiplier=1,this.game.clickCount=0,this.game.lastClickCount=0,this.game.lastClickTime=0,new GetReadyScreen(this.game)}return this},GameOverScreen.prototype.onMouseDown=function(click){this.startButton.down(click)},GameOverScreen.prototype.onMouseUp=function(click){this.startButton.up(click)},State.prototype.init=function(){this.chicken=new Body(this).setOrigin(0,0).setDimension(.1,.1).finalize(),this.fox=new Body(this).setOrigin(-.4*CANVAS_WIDTH,0).setDimension(.07,.07).finalize(),this.fox.thrust=.9,this.fox.targetRadius=.2;this.walls.push(new FixedBody(this).setOrigin(5e5-CANVAS_WIDTH,CANVAS_HEIGHT/2+.05).setDimension(1e6,.1).finalize()),this.walls.push(new FixedBody(this).setOrigin(5e5-CANVAS_WIDTH,-CANVAS_HEIGHT/2-.05).setDimension(1e6,.1).finalize()),this.invisibleWall=new FixedBody(this).setOrigin(-CANVAS_WIDTH/2-.05,0).setDimension(.1,CANVAS_HEIGHT+.1).finalize()},State.prototype.updateInvisibleWall=function(camera){this.invisibleWall.origin.x=camera.x-CANVAS_WIDTH/2-this.invisibleWall.dimension.x/2},State.prototype.updateTrees=function(camera){for(;this.treeCenter<camera.x;){this.treeCenter+=CANVAS_WIDTH,this.trees=this.removeInvisible(this.trees),this.grains=this.removeInvisible(this.grains);for(var N=7+this.treeCenter,i=0;i<N;i++){var tree=null,dist=0;do{var rand_x=Math.random()*CANVAS_WIDTH-CANVAS_WIDTH/2+this.treeCenter,rand_y=Math.random()*CANVAS_HEIGHT-CANVAS_HEIGHT/2;tree=new FixedBody(this).setOrigin(rand_x,rand_y).setDimension(.08,.08).finalize(),dist=Math.min(tree.origin.distanceFrom(this.fox.origin),tree.origin.distanceFrom(this.chicken.origin))}while(dist<.15);this.trees.push(tree)}this.trees.sort(function(t1,t2){return t2.origin.y-t1.origin.y});for(var N=7+this.treeCenter,i=0;i<N;i++){var rand_x=Math.random()*CANVAS_WIDTH-CANVAS_WIDTH/2+this.treeCenter,rand_y=Math.random()*CANVAS_HEIGHT-CANVAS_HEIGHT/2,grain=new FixedBody(this).setOrigin(rand_x,rand_y).setDimension(.04,.04).finalize();this.grains.push(grain)}this.grains.sort(function(t1,t2){return t2.origin.y-t1.origin.y})}},State.prototype.removeInvisible=function(bodies){for(var newBodies=[],i=0;i<bodies.length;i++)bodies[i].origin.x+bodies[i].dimension.x/2>this.invisibleWall.origin.x+this.invisibleWall.dimension.x&&newBodies.push(bodies[i]);return newBodies},State.prototype.advance=function(timestep){this.fox.target.set(this.chicken.origin);var collisions=this.collide(timestep);this.chicken.applyForces(timestep),this.fox.applyForces(timestep),collisions.forEach(function(collision){collision.apply()}),this.chicken.advance(timestep),this.fox.advance(timestep),this.chicken.checkTarget(),this.fox.eyesDir.set(this.fox.target).subtract(this.fox.origin),this.chicken.targetRadius>0&&this.chicken.eyesDir.set(this.chicken.target).subtract(this.chicken.origin)},State.prototype.collide=function(timestep){var collisions=[],newCollision=Body_collide(this,this.fox,this.chicken,timestep);null!==newCollision&&(collisions.push(newCollision),this.foxAteChicken=!0);for(i=0;i<this.trees.length;i++)null!==(newCollision=Body_collide(this,this.chicken,this.trees[i],timestep))&&collisions.push(newCollision);for(i=0;i<this.trees.length;i++)this.trees[i].origin.x>this.invisibleWall.origin.x&&null!==(newCollision=Body_collide(this,this.fox,this.trees[i],timestep))&&collisions.push(newCollision);for(var wallsLength=this.walls.length,i=0;i<wallsLength;i++)null!==(newCollision=Body_collide(this,this.chicken,this.walls[i],timestep))&&collisions.push(newCollision),null!==(newCollision=Body_collide(this,this.fox,this.walls[i],timestep))&&collisions.push(newCollision);null!==(newCollision=Body_collide(this,this.chicken,this.invisibleWall,timestep))&&collisions.push(newCollision);for(var eatenGrainsIdxs=[],i=0;i<this.grains.length;i++)null!==(newCollision=Body_collide(this,this.chicken,this.grains[i],timestep))&&eatenGrainsIdxs.push(i);if(eatenGrainsIdxs.length>0){for(var newGrains=[],j=0,idx=0;idx<this.grains.length;idx++)idx==eatenGrainsIdxs[j]?j++:newGrains.push(this.grains[idx]);this.grains=newGrains,this.eatenGrains+=eatenGrainsIdxs.length}return Collision_mergeCollisions(collisions)},UnionFind.prototype.findNode=function(id){if(void 0===this.nodes[id])return this.nodes[id]=new UnionFindNode(id),this.nodes[id];for(var root=this.nodes[id];root.id!==root.parent.id;)root=root.parent;return root},UnionFind.prototype.find=function(id){return this.findNode(id).id},UnionFind.prototype.union=function(x,y){var rootX=this.findNode(x),rootY=this.findNode(y);rootX.id!==rootY.id&&(rootX.rank<rootY.rank?rootX.parent=rootY:rootX.rank>rootY.rank?rootY.parent=rootX:(rootY.parent=rootX,rootX.rank++))},Array.prototype.addAll=function(arr){for(var len=arr.length,i=0;i<len;i++)this.push(arr[i])},Vector.prototype.set=function(v){return this.x=v.x,this.y=v.y,this},Vector.prototype.add=function(v){return this.x+=v.x,this.y+=v.y,this},Vector.prototype.subtract=function(v){return this.x-=v.x,this.y-=v.y,this},Vector.prototype.scale=function(f){return this.x*=f,this.y*=f,this},Vector.prototype.normalize=function(){var length=this.length();return length>0&&1!==length&&this.scale(1/length),this},Vector.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Vector.prototype.clear=function(){this.x=0,this.y=0},Vector.prototype.toString=function(){return this.x+", "+this.y},Vector.prototype.distanceFrom=function(other){return Vector_length(this.x-other.x,this.y-other.y)};